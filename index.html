<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Firebase Android Codelab by rohanraarora</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Firebase Android Codelab</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/rohanraarora/Firebase-Codelab" class="btn">View on GitHub</a>
      <a href="https://github.com/rohanraarora/Firebase-Codelab/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/rohanraarora/Firebase-Codelab/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="building-a-chat-application-for-android" class="anchor" href="#building-a-chat-application-for-android" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building a chat application for Android</h1>

<table>
<thead>
<tr>
<th align="center"><strong>Summary</strong></th>
<th align="center">In this codelab, you'll learn how to build a chat application for Android using Firebase.</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>URL</strong></td>
<td align="center"><a href="https://github.com/rohanraarora/Firebase-Codelab">https://github.com/rohanraarora/Firebase-Codelab</a></td>
</tr>
<tr>
<td align="center"><strong>Category</strong></td>
<td align="center">Firebase</td>
</tr>
<tr>
<td align="center"><strong>Feedback Link</strong></td>
<td align="center">You can provide feedback on the content bundle and codelab here.</td>
</tr>
</tbody>
</table>

<h2>
<a id="content" class="anchor" href="#content" aria-hidden="true"><span class="octicon octicon-link"></span></a>Content</h2>

<ul>
<li>Overview</li>
<li>What you’ll learn</li>
<li>What you’ll need</li>
<li>Create a Firebase application</li>
<li>Create a project in Android Studio</li>
<li>Connect the Android project to Firebase</li>
<li>Allow the user to send a message</li>
<li>Show the (existing and new) messages</li>
<li>Enable login</li>
<li>Wrap-up</li>
<li>What we've covered</li>
<li>Next Steps</li>
<li>Learn More</li>
</ul>

<h3>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview</h3>

<p>In this codelab you’ll build a chat application for Android using Firebase and Android Studio.<br>
We’ll allow users to log in with an email/password combination.</p>

<h3>
<a id="what-youll-learn" class="anchor" href="#what-youll-learn" aria-hidden="true"><span class="octicon octicon-link"></span></a>What you’ll learn</h3>

<ul>
<li>Interacting with a Firebase Database from an Android application.<br>
</li>
<li>Using Firebase Authentication in an Android application to authenticate users.</li>
</ul>

<h3>
<a id="what-youll-need" class="anchor" href="#what-youll-need" aria-hidden="true"><span class="octicon octicon-link"></span></a>What you’ll need</h3>

<ul>
<li>
<a href="https://developer.android.com/sdk/installing/studio.html">Android Studio</a> version 1.0+</li>
<li>A test device or emulator with Android 4.1+</li>
<li>The device must have internet access to access the Firebase servers</li>
<li>While we'll show you what to do in Android Studio, this codelab does not try to explain how Android works.</li>
</ul>

<h3>
<a id="create-a-firebase-application" class="anchor" href="#create-a-firebase-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create a Firebase application</h3>

<p>Duration: 0:10</p>

<p>The first step is to create a Firebase application. This will be the server-side component that our Android application talks to.
1.  Go to the <a href="https://www.firebase.com/">Firebase</a> web site<br>
2.  Login or sign up<br>
3.  Manage the app that was automatically created for you<br>
This app is on Firebase's free hacker plan. This plan is great for when you're developing your app on Firebase.<br>
4.  Any data that our Android application writes, will be visible in the Data tab<br>
5.  In the Login &amp; Auth tab, enable Email &amp; Password authentication  </p>

<h3>
<a id="create-a-project-in-android-studio" class="anchor" href="#create-a-project-in-android-studio" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create a project in Android Studio</h3>

<p>Duration: 0:10  </p>

<p>In this step we’ll create a project in Android Studio.<br>
1.  Start Android Studio and Start a new Android Studio project<br>
2.  You can name the project anything you want. But in the code below, we’ve named it Nanochat <br>
3.  Set the minimum SDK to 15 (ICS) or higher. We've left it on 19 (KitKat) here.<br>
4.  Start with a Blank Activity<br>
5.  We’ll leave all the defaults for this activity<br>
6.  If the project outline is not visible on the left, click the 1:Project label<br>
7.  Open up the main activity, which can be found in app/res/layout/activity_main.xml. In this file the root element will be a RelativeLayout and in there will be a TextView. We won’t be using the TextView, so delete it (or leave it and put a welcome message in it).</p>

<p>We now have a blank project in Android Studio. Let’s wire our app up to Firebase!</p>

<h3>
<a id="connect-the-android-project-to-firebase" class="anchor" href="#connect-the-android-project-to-firebase" aria-hidden="true"><span class="octicon octicon-link"></span></a>Connect the Android project to Firebase</h3>

<p>Duration: 0:15</p>

<p>Before we can start writing code that interacts with our Firebase database, we’ll need to make Android Studio aware that we’ll be using Firebase. We need to do this in two places: in the gradle build script and in our AndroidManifest.xml.</p>

<ul>
<li><p>open Gradle Scripts &gt; build.gradle (Module: app)<br>
This file contains the steps that Android Studio uses to build our app. We'll add a reference to Firebase to it, so we can start using it.</p></li>
<li><p>add the following line to the dependencies object at the bottom:  </p></li>
</ul>

<pre><code>    compile 'com.firebase:firebase-client-android:2.3.0+'
</code></pre>

<ul>
<li>add the following to the bottom of the android object<br>
</li>
</ul>

<pre><code>    packagingOptions {  
        exclude 'META-INF/LICENSE'  
        exclude 'META-INF/LICENSE-FIREBASE.txt'  
        exclude 'META-INF/NOTICE'  
    }  
</code></pre>

<ul>
<li><p>at this stage you’ll probably need to synchronize the project with the gradle files again, so Tools &gt; Android &gt; Sync Project with Gradle Files. Android Studio will parse the gradle files and pick up our changes.</p></li>
<li><p>since Firebase is a hosted service, our app will need to be able to access the internet.</p></li>
<li><p>open app &gt; manifests &gt; AndroidManifest.xml</p></li>
<li><p>add this line inside the manifest element  </p></li>
</ul>

<pre><code>    &lt;uses-permission android:name="android.permission.INTERNET" /&gt;  
</code></pre>

<ul>
<li><p>In this step we’ll also  set up the initial connection between our code and its Firebase backend.</p></li>
<li><p>open MainActivity.java and add this code to the end of the onCreate method:</p></li>
</ul>

<div class="highlight highlight-java"><pre>    <span class="pl-smi">Firebase</span><span class="pl-k">.</span>setAndroidContext(<span class="pl-v">this</span>);</pre></div>

<p>This code allows the Firebase client to keep its context.</p>

<ul>
<li>Import Firebase at the top of your MainActivity by adding the following line:</li>
</ul>

<div class="highlight highlight-java"><pre>    <span class="pl-k">import</span> <span class="pl-smi">com.firebase.client.Firebase</span>;</pre></div>

<ul>
<li><p>If Android Studio is having trouble finding the Firebase class, be sure that you’ve added the line to your gradle file and have synchronized the build file with the project.</p></li>
<li><p>We also want to create a connection to our database. We’ll keep this connection in a member field:  </p></li>
</ul>

<div class="highlight highlight-java"><pre>    <span class="pl-k">private</span> <span class="pl-smi">Firebase</span> mFirebaseRef;</pre></div>

<p>that we initialize in onCreate:  </p>

<div class="highlight highlight-java"><pre>    mFirebaseRef <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Firebase</span>(<span class="pl-s"><span class="pl-pds">"</span>https://&lt;your-app&gt;.firebaseio.com<span class="pl-pds">"</span></span>);</pre></div>

<p>Be sure to replace <code>&lt;your-app&gt;</code> with the name of the Firebase app you created in the first section.</p>

<p>That’s all the setup that is required. Next up we’ll allow the user to enter a message in our app and send the message to Firebase.</p>

<h3>
<a id="allow-the-user-to-send-a-message" class="anchor" href="#allow-the-user-to-send-a-message" aria-hidden="true"><span class="octicon octicon-link"></span></a>Allow the user to send a message</h3>

<p>Duration: 0:20</p>

<p>Now we can start sending data to Firebase! In this step we’ll allow the user to enter a message in a text box. When they then click the Send button, we will send the message to Firebase.</p>

<ul>
<li>We’ll first add the necessary views to activity_main.xml:</li>
</ul>

<pre><code>    &lt;LinearLayout
        android:id="@+id/footer"
        android:layout_alignParentBottom="true"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"&gt;
        &lt;EditText
            android:id="@+id/message_text"
            android:layout_width="0dp"
            android:layout_weight="1"
            android:layout_height="wrap_content"
            android:singleLine="true"
            android:inputType="textShortMessage" /&gt;
        &lt;Button
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="Send" /&gt;
    &lt;/LinearLayout&gt;
</code></pre>

<p>Now we have an EditText, where the user can enter their chat message, and a Button that they can click to send the message.</p>

<ul>
<li>In our MainActivity.java we’ll now add a member field for the EditText:</li>
</ul>

<div class="highlight highlight-java"><pre>    <span class="pl-smi">EditText</span> mEditText;</pre></div>

<p>and initialize it at the end of the onCreate method:</p>

<div class="highlight highlight-java"><pre>    mMessageEditText <span class="pl-k">=</span> (<span class="pl-smi">EditText</span>) <span class="pl-v">this</span><span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>message_text);</pre></div>

<ul>
<li>Next, we’ll add a method that grabs the text from the input and send it to our Firebase database:</li>
</ul>

<div class="highlight highlight-java"><pre>    <span class="pl-k">public</span> <span class="pl-k">void</span> onSendButtonClick(<span class="pl-smi">View</span> v) {
        <span class="pl-smi">String</span> message <span class="pl-k">=</span> mMessageEdit<span class="pl-k">.</span>getText()<span class="pl-k">.</span>toString();
        <span class="pl-k">Map&lt;<span class="pl-smi">String</span>,<span class="pl-smi">Object</span>&gt;</span> values <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">HashMap&lt;&gt;</span>();
        values<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>puf<span class="pl-pds">"</span></span>);
        values<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>message<span class="pl-pds">"</span></span>, message);
        mFirebaseRef<span class="pl-k">.</span>push()<span class="pl-k">.</span>setValue(values);
        mMessageEdit<span class="pl-k">.</span>setText(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
    }</pre></div>

<p>You will have to import the packages for some of these classes. Android Studio will tell you where to import them from.</p>

<ul>
<li><p>Here we grab the message from the EditText, add it to a Map, and send it off to Firebase. We’ll look at a way to replace that Map with something more type-safe in the next section, but for now this will work.
Also note that we hard-coded our user name for the moment. We’ll use Firebase Authentication to make this dynamic  in the last section of this code lab.</p></li>
<li><p>Now we'll wire up the onSendButtonClick method to the button in main_acitivity.xml by adding this attribute to the button:</p></li>
</ul>

<pre><code>    android:onClick="onSendButtonClick"
</code></pre>

<ul>
<li><p>If you now run the application in the emulator, you will see an input field with a Send button that sends the message to Firebase. Open the URL of your Firebase database, and you’ll see it light up green as you add new messages.</p></li>
<li><p>Open the Data tab in the Firebase Dashboard of your app. You’ll see it light up green as you add new messages. Admit it, this is pretty cool!</p></li>
</ul>

<p>Now that we can send messages to Firebase, it is time for the next step: making the messages show up in our Android app in realtime.</p>

<h3>
<a id="show-the-existing-and-new-messages" class="anchor" href="#show-the-existing-and-new-messages" aria-hidden="true"><span class="octicon octicon-link"></span></a>Show the (existing and new) messages</h3>

<p>Duration: 0:20</p>

<p>A chat app that doesn’t show existing messages is not very useful. So in this step we’ll add a list of the existing messages to our Android app. At the end of this section we’ll have a fully functional chat app.</p>

<p>Let's take this in chunks: first you'll build a new layout that we use to display each message, then you'll create a Java class to represent each message and finally we'll get the message from Firebase and put them into a ListView.</p>

<ul>
<li><p>Each chat message has the same layout. So we’ll create a new layout XML file for the messages.</p></li>
<li><p>Create a new layout file message_layout.xml</p></li>
<li><p>in the layout XML, change the orientation of the LinearLayout to horizontal, so the we can have the user name on the left and the message on the right of it.</p></li>
</ul>

<pre><code>    &lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
        android:orientation="horizontal" android:layout_width="match_parent"
        android:layout_height="match_parent"&gt;
</code></pre>

<ul>
<li>add two TextView controls to the layout: one for the username and one for the chat message:</li>
</ul>

<pre><code>    &lt;TextView
        android:id="@+id/username_text_view"
        android:text="Username"
        android:textStyle="bold"
        android:gravity="end"
        android:layout_width="0dp"
        android:layout_weight="3"
        android:layout_height="wrap_content"
        android:padding="10dp"/&gt;

    &lt;TextView
        android:id="@+id/message_text_view"
        android:text="Message"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:layout_weight="10"
        android:paddingLeft="0dp"
        android:paddingRight="10dp"
        android:paddingTop="10dp"
        android:paddingBottom="10dp"/&gt;
</code></pre>

<p>Most of these attributes are just there to make the messages look reasonable. So feel free to use your own padding and layout attributes. Just be sure to use the same R.id fields in your code that you specify in the android:id attributes in the XML.</p>

<ul>
<li>Now create a class ChatMessage.java that wraps the username and text message:</li>
</ul>

<div class="highlight highlight-java"><pre>      <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ChatMessage</span> {
          <span class="pl-k">private</span> <span class="pl-smi">String</span> name;
          <span class="pl-k">private</span> <span class="pl-smi">String</span> message;

          <span class="pl-k">public</span> <span class="pl-en">ChatMessage</span>() {
            <span class="pl-c">// necessary for Firebase's deserializer</span>
          }
          <span class="pl-k">public</span> <span class="pl-en">ChatMessage</span>(<span class="pl-smi">String</span> <span class="pl-v">name</span>, <span class="pl-smi">String</span> <span class="pl-v">message</span>) {
              <span class="pl-v">this</span><span class="pl-k">.</span>name <span class="pl-k">=</span> name;
              <span class="pl-v">this</span><span class="pl-k">.</span>message <span class="pl-k">=</span> message;
          }

          <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getName</span>() {
              <span class="pl-k">return</span> name;
          }

          <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getMessage</span>() {
              <span class="pl-k">return</span> message;
          }
      }</pre></div>

<p>As you can see, this is plain-old Java object. But it’s a POJO with some special traits. First ChatMessage follows a JavaBean pattern for its property names. The getName method is a getter for a name property, while getMessage is a getter for a message property. And second, those property names correspond to the ones we’ve been using when we sent messages to Firebase in our onSendButtonClick() function.</p>

<p>If you end up making this ChatMessage an inner class of another class, you must make it static: public static class ChatMessage.</p>

<ul>
<li><p>With the layout for the message specified and their structure defined in a class, now you need to make a space for them in the main_activity.xml</p></li>
<li><p>Add a ListView with android:id="<a href="https://github.com/android" class="user-mention">@android</a>:id/list" above the LinearLayout:</p></li>
</ul>

<pre><code>    &lt;ListView
        android:id="@android:id/list"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:layout_above="@+id/footer"/&gt;
</code></pre>

<p>This is the container that all messages will be added to: one message_layout for each ChatMessage.<br>
The id value is very important here, since Android uses it to find the ListView. So make sure to enter it exactly as specified: <a href="https://github.com/android" class="user-mention">@android</a>:id/list.</p>

<ul>
<li><p>Now download FirebaseListAdapter.java from <a href="https://github.com/rohanraarora/Firebase-Codelab/blob/master/app/src/main/java/com/gdgnd/firebasecodelab/FirebaseListAdapter.java">https://github.com/rohanraarora/Firebase-Codelab/blob/master/app/src/main/java/com/gdgnd/firebasecodelab/FirebaseListAdapter.java</a> and add it to your project. The FirebaseListAdapter class adapts a Firebase collection so that it becomes usable in an Android ListView. To add it to your app, add a new file to your application called FirebaseListAdapter and copy the Java code from the link above into that file. Don't forget to change the package name in the first line to match your project.</p></li>
<li><p>Make the MainActivity class descend from ListActivity. This is a built-in Android base-class. By deriving from this, our activity will automatically have access to the ListView we added to the layout:</p></li>
</ul>

<div class="highlight highlight-java"><pre>    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">MainActivity</span> <span class="pl-k">extends</span> <span class="pl-e">ListActivity</span> {</pre></div>

<ul>
<li>Now we'll make everything come together, by adding this to the onCreate method of our MainActivity:</li>
</ul>

<div class="highlight highlight-java"><pre>    mListAdapter <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">FirebaseListAdapter&lt;<span class="pl-smi">ChatMessage</span>&gt;</span>(mFirebaseRef, <span class="pl-smi">ChatMessage</span><span class="pl-k">.</span>class,
                                                        <span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>message_layout, <span class="pl-v">this</span>) {
        <span class="pl-k">@Override</span>
        <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">populateView</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>, <span class="pl-smi">ChatMessage</span> <span class="pl-v">model</span>) {
            ((<span class="pl-smi">TextView</span>)v<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>username_text_view))<span class="pl-k">.</span>setText(model<span class="pl-k">.</span>getName());
            ((<span class="pl-smi">TextView</span>)v<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>message_text_view))<span class="pl-k">.</span>setText(model<span class="pl-k">.</span>getMessage());
        }
    };
    setListAdapter(mListAdapter);</pre></div>

<p>The FirebaseListAdapter maps the data from your Firebase database into the ListView that you added to the layout. It creates a new instance of your message_layout for each ChatMessage and calls the populateView method. You override this method and put the name and message in the correct subviews.</p>

<ul>
<li><p>Don't worry, the hardest part is behind us now. All that is left in this step is some clean-up. But before that, run your app and see that it shows all existing messages. And if you send a new message, it shows up in the emulator and in your Firebase dashboard.</p></li>
<li><p>The cleanup is minor, but it's important to keep our code as readable as possible at all times. Remember that onSendButtonClick method that we wrote in step 5? That use of a Map looked a bit messy. Now that we have a ChatMessage class, we can make it much more readable:</p></li>
</ul>

<div class="highlight highlight-java"><pre>    <span class="pl-k">public</span> <span class="pl-k">void</span> onSendButtonClick(<span class="pl-smi">View</span> v) {
        <span class="pl-smi">String</span> message <span class="pl-k">=</span> mMessageEdit<span class="pl-k">.</span>getText()<span class="pl-k">.</span>toString();
        mFirebaseRef<span class="pl-k">.</span>push()<span class="pl-k">.</span>setValue(<span class="pl-k">new</span> <span class="pl-smi">ChatMessage</span>(<span class="pl-s"><span class="pl-pds">"</span>puf<span class="pl-pds">"</span></span>, message));
        mMessageEdit<span class="pl-k">.</span>setText(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
    }</pre></div>

<p>In this section we made our app show the chat messages. It was a lot of work, but in the end you can see that the Java code is not that big, Thanks to firebase.</p>

<h3>
<a id="enable-login" class="anchor" href="#enable-login" aria-hidden="true"><span class="octicon octicon-link"></span></a>Enable login</h3>

<p>Duration: 0:15
As a final step, we're going to allow the users of our app to log in using email and password.</p>

<ul>
<li>First add a button to the top right of activity_main.xml</li>
</ul>

<pre><code>    &lt;Button
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Login"
        android:id="@+id/login"
        android:layout_alignParentTop="true"
        android:layout_alignParentEnd="true"
        android:onClick="onLoginButtonClick" /&gt;
</code></pre>

<p>Note that the button refers to an onLoginButtonClick method, which you'll create in a few minutes.</p>

<ul>
<li>Now create a new layout called dialog_signin.xml, which we'll use to model the body of the sign-in dialog</li>
</ul>

<pre><code>    &lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
        android:orientation="vertical"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"&gt;
      &lt;EditText
          android:id="@+id/email"
          android:inputType="textEmailAddress"
          android:layout_width="match_parent"
          android:layout_height="wrap_content"
          android:layout_marginTop="16dp"
          android:layout_marginLeft="4dp"
          android:layout_marginRight="4dp"
          android:layout_marginBottom="4dp"
          android:hint="Email" /&gt;
      &lt;EditText
          android:id="@+id/password"
          android:inputType="textPassword"
          android:layout_width="match_parent"
          android:layout_height="wrap_content"
          android:layout_marginTop="4dp"
          android:layout_marginLeft="4dp"
          android:layout_marginRight="4dp"
          android:layout_marginBottom="16dp"
          android:hint="Password"/&gt;
    &lt;/LinearLayout&gt;
</code></pre>

<p>So we have two EditText controls under each other. The rest of the popup will be handled by a stock Android dialog.  Since your app will display the sign-in dialog as a popup, add the handling to MainActivity.java:</p>

<div class="highlight highlight-java"><pre>    <span class="pl-k">public</span> <span class="pl-k">void</span> onLoginButtonClick(<span class="pl-smi">View</span> v) {
        <span class="pl-smi">AlertDialog</span><span class="pl-k">.</span><span class="pl-smi">Builder</span> builder <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">AlertDialog</span>.<span class="pl-smi">Builder</span>(<span class="pl-v">this</span>);

        builder<span class="pl-k">.</span>setMessage(<span class="pl-s"><span class="pl-pds">"</span>Enter your email address and password<span class="pl-pds">"</span></span>)
               .setTitle(<span class="pl-s"><span class="pl-pds">"</span>Log in<span class="pl-pds">"</span></span>);

        <span class="pl-smi">LayoutInflater</span> inflater <span class="pl-k">=</span> <span class="pl-v">this</span><span class="pl-k">.</span>getLayoutInflater();
        builder<span class="pl-k">.</span>setView(inflater<span class="pl-k">.</span>inflate(<span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>dialog_signin, <span class="pl-c1">null</span>));

        builder<span class="pl-k">.</span>setPositiveButton(<span class="pl-s"><span class="pl-pds">"</span>OK<span class="pl-pds">"</span></span>, <span class="pl-k">new</span> <span class="pl-smi">DialogInterface</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">DialogInterface</span> <span class="pl-v">dialog</span>, <span class="pl-k">int</span> <span class="pl-v">id</span>) {
                <span class="pl-smi">AlertDialog</span> dlg <span class="pl-k">=</span> (<span class="pl-smi">AlertDialog</span>) dialog;
                <span class="pl-k">final</span> <span class="pl-smi">String</span> email <span class="pl-k">=</span> ((<span class="pl-smi">TextView</span>)dlg<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>email))<span class="pl-k">.</span>getText()<span class="pl-k">.</span>toString();
                <span class="pl-k">final</span> <span class="pl-smi">String</span> password <span class="pl-k">=</span>((<span class="pl-smi">TextView</span>)dlg<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>password))<span class="pl-k">.</span>getText()<span class="pl-k">.</span>toString();

                <span class="pl-c">// TODO: sign in to Firebase</span>

            }
        });
        builder<span class="pl-k">.</span>setNegativeButton(<span class="pl-s"><span class="pl-pds">"</span>Cancel<span class="pl-pds">"</span></span>, <span class="pl-c1">null</span>);

        <span class="pl-smi">AlertDialog</span> dialog <span class="pl-k">=</span> builder<span class="pl-k">.</span>create();
        dialog<span class="pl-k">.</span>show();
    }</pre></div>

<p>This method builds and show the dialog, with our two text boxes as the main body. When the user clicks OK, it extracts the email address and password from the text controls.</p>

<ul>
<li>Now wire the values that we got from the dialog to the Firebase Authentication back-end. Replace the TODO with the following code:</li>
</ul>

<div class="highlight highlight-java"><pre>    mFirebaseRef<span class="pl-k">.</span>createUser(email, password, <span class="pl-k">new</span> <span class="pl-smi">Firebase</span>.<span class="pl-smi">ResultHandler</span>() {
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onSuccess</span>() {
            mFirebaseRef<span class="pl-k">.</span>authWithPassword(email, password, <span class="pl-c1">null</span>);
        }
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onError</span>(<span class="pl-smi">FirebaseError</span> <span class="pl-v">firebaseError</span>) {
            mFirebaseRef<span class="pl-k">.</span>authWithPassword(email, password, <span class="pl-c1">null</span>);
        }
    });</pre></div>

<p>In this code, we always try to register the user. If the user already registered that will result in onError, otherwise it will result on onSuccess.<br>
Either way, we next call authWithPassword to authenticate the (pre-existing or just-created) user.  </p>

<ul>
<li><p>With the above we have the registration/login flow working. But we still need to listen to when Firebase Authentication tells us the user has been authenticated, so that we can store the username and use that in the chat message instead of the hard-coded value we have now.</p></li>
<li><p>Add a field to the class to hold the user name:</p></li>
</ul>

<div class="highlight highlight-java"><pre>    <span class="pl-k">private</span> <span class="pl-smi">String</span> mUsername;</pre></div>

<ul>
<li>Add the end of the onCreate method, add a callback method that listens for authentication state changes in Firebase:</li>
</ul>

<div class="highlight highlight-java"><pre>    mFirebaseRef<span class="pl-k">.</span>addAuthStateListener(<span class="pl-k">new</span> <span class="pl-smi">Firebase</span>.<span class="pl-smi">AuthStateListener</span>() {
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onAuthStateChanged</span>(<span class="pl-smi">AuthData</span> <span class="pl-v">authData</span>) {
            <span class="pl-k">if</span>(authData <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
                mUsername <span class="pl-k">=</span> ((<span class="pl-smi">String</span>)authData<span class="pl-k">.</span>getProviderData()<span class="pl-k">.</span>get(<span class="pl-s"><span class="pl-pds">"</span>email<span class="pl-pds">"</span></span>));
                findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>login)<span class="pl-k">.</span>setVisibility(<span class="pl-smi">View</span><span class="pl-c1"><span class="pl-k">.</span>INVISIBLE</span>);
            }
            <span class="pl-k">else</span> {
                mUsername <span class="pl-k">=</span> <span class="pl-c1">null</span>;
                findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>login)<span class="pl-k">.</span>setVisibility(<span class="pl-smi">View</span><span class="pl-c1"><span class="pl-k">.</span>VISIBLE</span>);
            }
        }
    });</pre></div>

<p>Firebase calls our listener whenever the authentication state changes, so whenever the user logs in or out. When the user logs in, we store their email address in our field and hide the login button.</p>

<p>Firebase Authentication supports multiple authentication providers and each of them exposes a different set of data. For example, if we'd allow our users to authenticate with their existing Twitter account, we could identify them by their twitter handle.</p>

<ul>
<li>Finally, replace the hard-coded username with the field we just populated:</li>
</ul>

<div class="highlight highlight-java"><pre>    mFirebaseRef<span class="pl-k">.</span>push()<span class="pl-k">.</span>setValue(<span class="pl-k">new</span> <span class="pl-smi">ChatMessage</span>(mUsername, message));</pre></div>

<p>We could definitely improve the layout of things. But this step has been long enough as it is. So let's wrap up with a few notes.</p>

<ul>
<li>One thing you may note is that the user stays logged in, even when they restart the app. If instead you want to sign out the user, you can call:</li>
</ul>

<div class="highlight highlight-java"><pre>    mFirebaseRef<span class="pl-k">.</span>unauth();</pre></div>

<p>This will trigger the AuthStateListener we created before, which will clear the username field and re-enable the login button.</p>

<ul>
<li>If you want to know which users logged in to your application, you can find them in the Login &amp; Auth tab of your Firebase's dashboard.</li>
</ul>

<p>This is also where you can configure the password reset emails that you can send to your users, in case they forgot their password.</p>

<h3>
<a id="wrap-up" class="anchor" href="#wrap-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wrap-up</h3>

<p>Congratulations! You've just built a fully functional multi-user chat application that uses Firebase to store the data and authentication users.</p>

<p>As a reward for finishing the codelab you’ve earned a promo code! When you’re ready to put your Firebase app in production, you can use the promo code <strong>androidcodelab49</strong> for $49 off your first month of a paid Firebase plan. Just enter the code when you upgrade your Firebase. </p>

<h3>
<a id="what-weve-covered" class="anchor" href="#what-weve-covered" aria-hidden="true"><span class="octicon octicon-link"></span></a>What we've covered</h3>

<p>✓ Interacting with a Firebase Database from an Android application.<br>
✓ Using Firebase Authentication in an Android application to authenticate users.</p>

<h3>
<a id="next-steps" class="anchor" href="#next-steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Next Steps</h3>

<ul>
<li>Add a log-out button to the app</li>
<li>Add a password-reset button to the login dialog</li>
<li>Allow the user to specify a nickname or use one of the Firebase's social authentication providers to look up their first name.</li>
<li>Get your app on the Play Store!
Learn More</li>
<li>Learn all about using <a href="https://www.firebase.com/docs/android/">Firebase with Android</a> by following the <a href="https://www.firebase.com/docs/android/guide/">Firebase for Android development guide</a>.</li>
<li>Study a more advanced sample application: <a href="https://github.com/firebase/AndroidDrawing">AndroidDrawing</a>
</li>
<li>Learn about <a href="https://github.com/firebase/geofire-java">GeoFire</a> for Java, which allows you to add realtime location queries to your Android application</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/rohanraarora/Firebase-Codelab">Firebase Android Codelab</a> is maintained by <a href="https://github.com/rohanraarora">rohanraarora</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
